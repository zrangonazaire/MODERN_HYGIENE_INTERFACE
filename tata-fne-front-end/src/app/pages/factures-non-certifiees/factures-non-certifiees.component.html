<div class="layout">
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-logo">
        <img src="/logo.png" alt="Logo" />
      </div>
      <div class="brand-caption">Facture Normalisée Électronique</div>
    </div>

    <nav class="menu">
      <a class="menu-item" routerLink="/dashboard" routerLinkActive="active">
        <span class="icon">D</span>
        Tableau de bord
      </a>
      <a class="menu-item active" routerLink="/factures-non-certifiees" routerLinkActive="active">
        <span class="icon">X</span>
        Certification par fichier Excel
      </a>
      <a class="menu-item">
        <span class="icon">A</span>
        Certification par API SAP
      </a>
      <a class="menu-item" routerLink="/factures-certifiees" routerLinkActive="active">
        <span class="icon">F</span>
        Factures Certifiées
      </a>
      <a class="menu-item">
        <span class="icon">P</span>
        Paramètres
      </a>
    </nav>

    <div class="logout">
      <button type="button" (click)="logout()">Se déconnecter</button>
      <small>v1.0.2 (04/11/2025)</small>
    </div>
  </aside>

  <div class="content">
    <header class="topbar">
      <div class="breadcrumbs">Pages / Certification par fichier Excel</div>
      <div class="top-actions">
        <a class="link">{{ userFullName() }}</a>
        <a class="link">Notifications</a>
      </div>
    </header>

    <section class="page-heading">
      <div>
        <p class="eyebrow">Certification par fichier Excel</p>
        <p class="lede">Contrôle, validation et préparation des factures avant certification.</p>
      </div>
      <div class="heading-actions">
        <button class="ghost">Télécharger le modèle</button>
        <input #excelInput type="file" accept=".xls,.xlsx" class="hidden-input" (change)="onFileSelected($event)" />
        <button class="secondary" (click)="excelInput.click()">Lire Excel</button>
        <button class="primary" type="button">Nouvelle facture</button>
      </div>
    </section>

    <section class="summary">
      <div class="summary-card">
        <p>Total dossiers</p>
        <h2>{{ totals().total }}</h2>
      </div>
      <div class="summary-card accent">
        <p>En attente</p>
        <h2>{{ totals().pending }}</h2>
      </div>
      <div class="summary-card">
        <p>Certifiées</p>
        <h2>{{ totals().certified }}</h2>
      </div>
      <div class="summary-card danger">
        <p>Rejetées</p>
        <h2>{{ totals().rejected }}</h2>
      </div>
    </section>

    <section class="filters">
      <div class="filter">
        <label>Recherche rapide</label>
        <input
          type="text"
          placeholder="Référence, client, identifiant..."
          [ngModel]="query()"
          (ngModelChange)="query.set($event)"
        />
      </div>
      <div class="filter">
        <label>Statut</label>
        <select [ngModel]="statusFilter()" (ngModelChange)="statusFilter.set($event)">
          <option value="all">Tous</option>
          <option value="a_certifier">A certifier</option>
          <option value="en_attente">En attente</option>
          <option value="rejete">Rejeté</option>
          <option value="certifie">Certifié</option>
        </select>
      </div>
      <div class="filter actions">
        <label>Actions</label>
        <div class="action-group">
          <button class="ghost">Voir anomalies</button>
          <button class="primary" type="button" (click)="certifyAll()">
            Certification en masse ({{ apiInvoicesCount() }})
          </button>
        </div>
      </div>
    </section> 

    @if (readState() !== 'idle' || certifyState() !== 'idle') {
      <div class="alert info" *ngIf="readState() === 'loading'">
        Lecture en cours...
      </div>
      <div class="alert success" *ngIf="readState() === 'success' && readResult()">
        <strong>Lecture terminée.</strong>
        {{ readResult()!.rowCount }} lignes chargées.
      </div>
      <div class="alert error" *ngIf="readState() === 'error'">
        {{ readError() || 'Une erreur est survenue.' }}
      </div>
      <div class="alert info" *ngIf="certifyState() === 'loading'">
        Certification en masse en cours...
      </div>
      <div class="alert success" *ngIf="certifyState() === 'success'">
        <strong>Certification terminée.</strong>
        {{ certifyCount() }} facture(s) certifiée(s).
      </div>
      <div class="alert error" *ngIf="certifyState() === 'error'">
        {{ certifyError() || 'Une erreur est survenue.' }}
      </div>
    }

    @if (actionError()) {
      <div class="alert error">
        {{ actionError() }}
      </div>
    }

    <section class="card table-card">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th class="checkbox-col">
                <input
                  type="checkbox"
                  [checked]="filteredInvoices().length > 0 && selectedCount() === filteredInvoices().length"
                  (change)="toggleAll($any($event.target).checked)"
                />
              </th>
              <th>NumeroFacture</th>
              <th>TypeClient</th>
              <th>CodeClient</th>
              <th>NomClient</th>
              <th>NCCClient</th>
              <th>TelephoneClient</th>
              <th>EmailClient</th>
              <th>RefArticle</th>
              <th>Designation</th>
              <th>Quantite</th>
              <th>PrixUnitaireHT</th>
              <th>CodeTaxe</th>
              <th>Unite</th>
              <th>Remise</th>
              <th>ModePaiement</th>
              <th>Devise</th>
              <th>TauxChange</th>
              <th>commentaire</th>
              <th>ClientSellerName</th>
              <th>Statut</th>
              <th>Source</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (invoice of filteredInvoices(); track trackById($index, invoice)) {
              <tr>
                <td class="checkbox-col">
                  <input
                    type="checkbox"
                    [checked]="isSelected(invoice.id)"
                    (change)="toggleSelection(invoice.id)"
                  />
                </td>
                <td>
                  <div class="fw-semibold">{{ invoice.invoiceNumber }}</div>
                  <small class="muted">ID {{ invoice.id }}</small>
                </td>
                <td>{{ invoice.typeClient || invoice.invoiceType || '-' }}</td>
                <td>{{ invoice.codeClient || '-' }}</td>
                <td>{{ invoice.clientCompanyName || invoice.nomClient || '-' }}</td>
                <td>{{ invoice.clientNcc || '-' }}</td>
                <td>{{ invoice.telephoneClient || '-' }}</td>
                <td>{{ invoice.emailClient || '-' }}</td>
                <td>{{ invoice.refArticle || '-' }}</td>
                <td>{{ invoice.designation || '-' }}</td>
                <td>{{ invoice.quantite || '-' }}</td>
                <td>{{ invoice.prixUnitaireHT || '-' }}</td>
                <td>{{ invoice.codeTaxe || '-' }}</td>
                <td>{{ invoice.unite || '-' }}</td>
                <td>{{ invoice.remise || '-' }}</td>
                <td>{{ invoice.paymentMethod || invoice.modePaiement || '-' }}</td>
                <td>{{ invoice.devise || '-' }}</td>
                <td>{{ invoice.tauxChange || '-' }}</td>
                <td>{{ invoice.commentaire || '-' }}</td>
                <td>{{ invoice.clientSellerName || '-' }}</td>
                <td>
                  <span class="status-badge" [class]="normalizeStatus(invoice)">
                    {{ getStatusLabel(normalizeStatus(invoice)) }}
                  </span>
                </td>
                <td>{{ getEmissionLabel(invoice) }}</td>
                <td class="text-end">
                  <button
                    class="primary tiny"
                    type="button"
                    [disabled]="certifyingId() === invoice.id"
                    (click)="certifyOne(invoice)"
                  >
                    {{ certifyingId() === invoice.id ? 'Certification...' : 'Certifier FNE' }}
                  </button>
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="10" class="empty">Aucune facture disponible. Modifiez vos filtres ou importez un Excel.</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </section>
  </div>
</div>
